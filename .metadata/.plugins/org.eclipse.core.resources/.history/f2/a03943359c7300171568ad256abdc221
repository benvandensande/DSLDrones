/*
 * generated by Xtext 2.10.0
 */
package org.xtext.example.mydsl.validation

import java.util.List
import org.eclipse.emf.ecore.EObject
import org.eclipse.xtext.validation.Check
import org.xtext.example.mydsl.myLanguage.Given
import org.xtext.example.mydsl.myLanguage.MissionStatusSent
import org.xtext.example.mydsl.myLanguage.RobotStateSent
import org.xtext.example.mydsl.myLanguage.Statement
import org.xtext.example.mydsl.myLanguage.Test
import org.xtext.example.mydsl.myLanguage.TestFile
import org.xtext.example.mydsl.myLanguage.Then
import org.xtext.example.mydsl.myLanguage.When
import org.xtext.example.mydsl.myLanguage.impl.GivenImpl
import org.xtext.example.mydsl.myLanguage.impl.WhenImpl
import org.xtext.example.mydsl.myLanguage.MyLanguagePackage

/**
 * This class contains custom validation rules. 
 *
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
class MyLanguageValidator extends AbstractMyLanguageValidator {
	
	private val INVALID_NAME = 'invalidName'
	private EObject o
	private TestFile testFile
	
	@Check
	def checkCorrectSequence(Test test) {
		val statements = test.statements;
		for (Statement s : statements) {
			var b = false;
			switch s {
				Given case (s instanceof Given):
					b = s.checkNot()
				When case (s instanceof When):
					b = s.checkNot(statements)
				Then case (s instanceof Then):
					b = s.checkNot(statements)
				}
			if(b){
				error('Correct sequence is Given, When, Then', MyLanguagePackage.Literals.TEST__NAME, INVALID_NAME)
				}
			}
		}
	
	def boolean checkNot(Given statement){
		return false;
	}
	def boolean checkNot(When statement, List<Statement> s){
		val index = s.indexOf(statement)
		var next = s.get(index)
		if(index < s.length-1){
			next = s.get(index+1);
		}
		if(next.class.equals(GivenImpl)){
			return true
		}else{
			return false;
		}
		
	}
	def boolean checkNot(Then statement, List<Statement> s){
		val index = s.indexOf(statement)
		var next = s.get(index)
		if(index < s.length-1){
			next = s.get(index+1);
		}
		if(next.class.equals(GivenImpl) ||
			next.class.equals(WhenImpl)
		){
			return true
		}else{
			return false;
		}
	}

	@Check
	def checkSameName(Test test) {
		o = test.eContainer();
		testFile = o as TestFile;
		val tests = testFile.tests;
		for (Test t : tests) {
			if (!t.equals(test) && test.name.equals(t.name)) {
				error('Tests must have different names', MyLanguagePackage.Literals.TEST__NAME, INVALID_NAME)
			}
		}
	}
	
	@Check
	def checkCorrectState(RobotStateSent sent) {
		val state = sent.state;
		if(!state.toString.equals("FLYING") && !state.toString.equals("HOVER")
			&& !state.toString.equals("LANDED") && !state.toString.equals("TAKEOFF")
			&& !state.toString.equals("EMERGENCYLANDING") && !state.toString.equals("LANDING")
		){
			error('State must be FLYING, HOVER, LANDED, EMERGENCYLANDING or TAKEOFF', MyLanguagePackage.Literals.ROBOT_STATE_SENT__STATE, INVALID_NAME)
		}
	}
	
	@Check
	def checkMissionStatus(MissionStatusSent sent) {
		val state = sent.state.toLowerCase;
		if(!state.toString.equals("active") && !state.toString.equals("unactive")
			&& !state.toString.equals("paused")
		){
			error('Must fill in a mission status', MyLanguagePackage.Literals.MISSION_STATUS_SENT__STATE, INVALID_NAME)
		}
	}
	
	

}